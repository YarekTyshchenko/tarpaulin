name: Release

on:
  push:
    # TODO: Remove this
    branches:
      - "binstall-signing"
    tags:
      - '[0-9]+.*'
jobs:
  keygen:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: cargo-bins/cargo-binstall@main
    - name: Install binaries required
      run: cargo binstall -y --force rsign2 rage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create ephemeral keypair
      id: keypair
      env:
        AGE_KEY_PUBLIC: ${{ vars.AGE_KEY_PUBLIC }}
      run: .github/scripts/ephemeral-gen.sh
    - uses: actions/upload-artifact@v4
      with:
        name: minisign.pub
        path: minisign.pub
    - uses: actions/upload-artifact@v4
      with:
        name: minisign.key.age
        path: minisign.key.age
        retention-days: 1
    - name: Check that key can be decrypted
      env:
        AGE_KEY_SECRET: ${{ secrets.AGE_KEY_SECRET }}
      shell: bash
      run: .github/scripts/ephemeral-sign.sh minisign.pub

#  create-release:
#    name: "Create GitHub release"
#    # only publish from the origin repository
#    if: github.repository_owner == 'xd009642'
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - uses: taiki-e/create-gh-release-action@v1
#        with:
#          changelog: CHANGELOG.md
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  crates:
    runs-on: ubuntu-latest
    needs:
      - keygen
    steps:
      - uses: actions/checkout@v3

      - name: Build package
        run: cargo package

      - uses: cargo-bins/cargo-binstall@main
      - name: Install binaries required
        run: cargo binstall -y --force rsign2 rage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/download-artifact@v4
        with:
          name: minisign.key.age

      # Add signature to Cargo.toml
      - uses: actions/download-artifact@v4
        with:
          name: minisign.pub
      - run: .github/scripts/ephemeral-crate.sh

      - name: Sign package
        env:
          AGE_KEY_SECRET: ${{ secrets.AGE_KEY_SECRET }}
        shell: bash
        run: .github/scripts/ephemeral-sign.sh target/package/cargo-tarpaulin-*.crate

      - name: Publish package to crates
        run: cargo publish --allow-dirty --token ${{ secrets.CARGO_TOKEN }}
#
#  binaries:
#    name: "Upload release binaries"
#    needs:
#      - create-release
#    strategy:
#      fail-fast: false
#      matrix:
#        include:
#          - target: x86_64-unknown-linux-gnu
#            os: ubuntu-latest
#          - target: x86_64-unknown-linux-musl
#            os: ubuntu-latest
#          - target: x86_64-apple-darwin
#            os: macos-latest
#          - target: x86_64-pc-windows-msvc
#            os: windows-latest
#          - target: aarch64-unknown-linux-gnu
#            os: ubuntu-latest
#          - target: aarch64-unknown-linux-musl
#            os: ubuntu-latest
#          - target: aarch64-apple-darwin
#            os: macos-latest
#          - target: universal-apple-darwin
#            os: macos-latest
#    runs-on: ${{ matrix.os }}
#    steps:
#      - uses: actions/checkout@v3
#      - uses: dtolnay/rust-toolchain@stable
#      - uses: taiki-e/upload-rust-binary-action@v1
#        with:
#          bin: cargo-tarpaulin
#          target: ${{ matrix.target }}
#          features: vendored-openssl
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
